<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BRS DApp（BTD/BTB）— 单文件</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- ethers：首选 v6 UMD；若被缓存/CDN 阻拦，可改用备用 CDN（注释行）-->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.min.js"></script>
  <!-- 备用：<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.2/ethers.umd.min.js"></script> -->
  <style> body{ -webkit-font-smoothing: antialiased } </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-gray-50 to-gray-100">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    // ============ 兼容 v6/v5 的 ethers 工具层（修复 BrowserProvider 报错） ============
    const E = () => window.ethers || undefined;
    const isV6 = () => !!E()?.BrowserProvider;

    function makeProvider(injected) {
      const e = E();
      if (!e) throw new Error("未加载 ethers UMD（可能被扩展/网络阻止）。");
      if (e.BrowserProvider) return { p: new e.BrowserProvider(injected, 'any'), v: 6 };
      if (e.providers?.Web3Provider) return { p: new e.providers.Web3Provider(injected, 'any'), v: 5 };
      throw new Error("找不到 BrowserProvider/Web3Provider，ethers 版本异常。");
    }
    const MaxUint = () => (E()?.MaxUint256 ?? E()?.constants?.MaxUint256);
    const parseUnitsX = (v, d) => (E()?.parseUnits ? E().parseUnits(v, d) : E().utils.parseUnits(v, d));
    const formatUnitsX = (v, d) => (E()?.formatUnits ? E().formatUnits(v, d) : E().utils.formatUnits(v, d));
    const toUintRaw = (v) => (isV6() ? BigInt(v) : E().BigNumber.from(String(v)));
    async function estimateX(c, method, ...args){
      // v6: c.fn.estimateGas; v5: c.estimateGas.fn
      if (c[method]?.estimateGas) return c[method].estimateGas(...args);
      if (c.estimateGas?.[method]) return c.estimateGas[method](...args);
      return null;
    }

    // ================== 合约 ABI & 地址 ==================
    const DEFAULT_ADDR = { BTD:"", BTB:"", MINT:"", CONFIG:"" };
    const ERC20_MIN_ABI = [
      { type:"function", name:"name", stateMutability:"view", inputs:[], outputs:[{type:"string"}] },
      { type:"function", name:"symbol", stateMutability:"view", inputs:[], outputs:[{type:"string"}] },
      { type:"function", name:"decimals", stateMutability:"view", inputs:[], outputs:[{type:"uint8"}] },
      { type:"function", name:"balanceOf", stateMutability:"view", inputs:[{name:"owner",type:"address"}], outputs:[{type:"uint256"}] },
      { type:"function", name:"allowance", stateMutability:"view", inputs:[{name:"owner",type:"address"},{name:"spender",type:"address"}], outputs:[{type:"uint256"}] },
      { type:"function", name:"approve", stateMutability:"nonpayable", inputs:[{name:"spender",type:"address"},{name:"value",type:"uint256"}], outputs:[{type:"bool"}] },
    ];
    const BTD_ABI = [ ...ERC20_MIN_ABI,
      { type:"function", name:"rebase", stateMutability:"nonpayable", inputs:[], outputs:[] },
      { type:"function", name:"setAnnualRateBP", stateMutability:"nonpayable", inputs:[{name:"rateBP",type:"uint256"}], outputs:[] },
    ];
    const BTB_ABI = [ ...ERC20_MIN_ABI,
      { type:"function", name:"rebase", stateMutability:"nonpayable", inputs:[], outputs:[] },
      { type:"function", name:"setAnnualRateBP", stateMutability:"nonpayable", inputs:[{name:"rateBP",type:"uint256"}], outputs:[] },
    ];
    const MINT_ABI = [
      { type:"function", name:"mintBTD", stateMutability:"nonpayable", inputs:[{name:"amount",type:"uint256"}], outputs:[] },
      { type:"function", name:"burnBTD", stateMutability:"nonpayable", inputs:[{name:"amount",type:"uint256"}], outputs:[] },
      { type:"function", name:"burnBTB", stateMutability:"nonpayable", inputs:[{name:"amount",type:"uint256"}], outputs:[] },
    ];
    const CONFIG_ABI = [
      { type:"function", name:"btcPrice", stateMutability:"view", inputs:[], outputs:[{type:"uint256"}] },
      { type:"function", name:"btbPrice", stateMutability:"view", inputs:[], outputs:[{type:"uint256"}] },
      { type:"function", name:"annualRateBP", stateMutability:"view", inputs:[], outputs:[{type:"uint256"}] },
      { type:"function", name:"setBtcPrice", stateMutability:"nonpayable", inputs:[{name:"p",type:"uint256"}], outputs:[] },
      { type:"function", name:"setBtbPrice", stateMutability:"nonpayable", inputs:[{name:"p",type:"uint256"}], outputs:[] },
      { type:"function", name:"setAnnualRateBP", stateMutability:"nonpayable", inputs:[{name:"rateBP",type:"uint256"}], outputs:[] },
    ];

    // ================== UI 基础 ==================
    const Section = ({title, children}) => (
      <div className="rounded-2xl shadow p-5 bg-white border border-gray-100">
        <div className="text-xl font-semibold mb-4">{title}</div>{children}
      </div>
    );
    const Field = ({label, children}) => (
      <label className="block mb-3"><div className="text-sm text-gray-600 mb-1">{label}</div>{children}</label>
    );
    const Input = ({value, onChange, placeholder, type="text"}) => (
      <input className="w-full rounded-xl border p-3 focus:outline-none focus:ring" value={value} onChange={e=>onChange(e.target.value)} placeholder={placeholder} type={type} />
    );

    // ================== 连接 Hook ==================
    function getInjected(){ const eth = window?.ethereum; if(!eth) return null; if(Array.isArray(eth.providers)&&eth.providers.length){ const mm=eth.providers.find(p=>p&&p.isMetaMask); return mm||eth.providers[0]; } return eth; }
    function inIframe(){ try { return window.self !== window.top; } catch(_) { return true; } }

    function useEthers(){
      const [provider,setProvider] = useState(null);
      const [signer,setSigner] = useState(null);
      const [account,setAccount] = useState("");
      const [chainId,setChainId] = useState(null);
      const [lastError,setLastError] = useState("");
      async function connect(){
        setLastError("");
        try{
          const injected = getInjected();
          if(!injected) throw new Error("未检测到钱包注入（window.ethereum 不可用）。请确认已安装 MetaMask，或在新窗口打开页面。");
          const { p, v } = makeProvider(injected);
          // v5/v6 都支持 send
          await p.send('eth_requestAccounts', []);
          const s = await p.getSigner();
          const net = await p.getNetwork();
          setProvider(p); setSigner(s); setAccount(await s.getAddress()); setChainId(Number(net.chainId));
          return true;
        }catch(e){
          const raw = e?.message || String(e);
          let msg = raw;
          if (e && (e.code === 4001 || raw.includes('User rejected'))) msg = '用户拒绝了连接请求。';
          else if (inIframe()) msg = `可能是 iframe 环境未注入钱包。请在新窗口打开再试。原始：${raw}`;
          setLastError(msg); throw new Error(msg);
        }
      }
      useEffect(()=>{
        const eth = getInjected(); if(!eth) return;
        const onChainChanged = ()=> window.location.reload();
        const onAccountsChanged = (accs)=> setAccount(accs?.[0]||"");
        eth.on?.('chainChanged', onChainChanged);
        eth.on?.('accountsChanged', onAccountsChanged);
        return ()=>{
          eth.removeListener?.('chainChanged', onChainChanged);
          eth.removeListener?.('accountsChanged', onAccountsChanged);
        };
      },[]);
      return { provider, signer, account, chainId, connect, lastError };
    }

    // ================== 主应用 ==================
    function App(){
      const { provider, signer, account, chainId, connect, lastError } = useEthers();
      const [addrBTD,setAddrBTD] = useState(DEFAULT_ADDR.BTD);
      const [addrBTB,setAddrBTB] = useState(DEFAULT_ADDR.BTB);
      const [addrMint,setAddrMint] = useState(DEFAULT_ADDR.MINT);
      const [addrConfig,setAddrConfig] = useState(DEFAULT_ADDR.CONFIG);

      const cBTD = useMemo(()=> (provider&&addrBTD? new E().Contract(addrBTD, BTD_ABI, provider):null), [provider, addrBTD]);
      const cBTDWrite = useMemo(()=> (signer&&addrBTD? new E().Contract(addrBTD, BTD_ABI, signer):null), [signer, addrBTD]);
      const cBTB = useMemo(()=> (provider&&addrBTB? new E().Contract(addrBTB, BTB_ABI, provider):null), [provider, addrBTB]);
      const cBTBWrite = useMemo(()=> (signer&&addrBTB? new E().Contract(addrBTB, BTB_ABI, signer):null), [signer, addrBTB]);
      const cMint = useMemo(()=> (provider&&addrMint? new E().Contract(addrMint, MINT_ABI, provider):null), [provider, addrMint]);
      const cMintWrite = useMemo(()=> (signer&&addrMint? new E().Contract(addrMint, MINT_ABI, signer):null), [signer, addrMint]);
      const cConfig = useMemo(()=> (provider&&addrConfig? new E().Contract(addrConfig, CONFIG_ABI, provider):null), [provider, addrConfig]);
      const cConfigWrite = useMemo(()=> (signer&&addrConfig? new E().Contract(addrConfig, CONFIG_ABI, signer):null), [signer, addrConfig]);

      const [decBTD,setDecBTD]=useState(18); const [decBTB,setDecBTB]=useState(18);
      const [balBTD,setBalBTD]=useState("-"); const [balBTB,setBalBTB]=useState("-");
      async function refreshBalances(){ try{
        if(cBTD && account){ const d= (await cBTD.decimals().catch(()=>18))||18; setDecBTD(Number(d)); const raw= await cBTD.balanceOf(account); setBalBTD(formatUnitsX(raw, Number(d))); }
        if(cBTB && account){ const d= (await cBTB.decimals().catch(()=>18))||18; setDecBTB(Number(d)); const raw= await cBTB.balanceOf(account); setBalBTB(formatUnitsX(raw, Number(d))); }
      }catch(e){ console.error(e); } }
      useEffect(()=>{ refreshBalances(); }, [cBTD,cBTB,account]);

      const [readBtcPrice,setReadBtcPrice]=useState("-");
      const [readBtbPrice,setReadBtbPrice]=useState("-");
      const [readAnnualBP,setReadAnnualBP]=useState("-");
      async function refreshConfigViews(){ try{
        if(!cConfig) return; const [bp,btbp,ann]= await Promise.all([
          cConfig.btcPrice().catch(()=>null), cConfig.btbPrice().catch(()=>null), cConfig.annualRateBP().catch(()=>null)
        ]); setReadBtcPrice(bp!==null?String(bp):"-"); setReadBtbPrice(btbp!==null?String(btbp):"-"); setReadAnnualBP(ann!==null?String(ann):"-");
      }catch(e){ console.error(e); } }
      useEffect(()=>{ refreshConfigViews(); }, [cConfig]);

      const [amtBTD,setAmtBTD]=useState("0");
      const [amtBTBBurn,setAmtBTBBurn]=useState("0");
      const [setterName,setSetterName]=useState("setBtcPrice");
      const [setterValue,setSetterValue]=useState("0");
      const [priceDecimals,setPriceDecimals]=useState("8");
      const [msg,setMsg]=useState("");

      async function approveToken(token, spender, amount, decimals){ try{
        if(!signer) return setMsg('请先连接钱包'); const ctr = token==='BTD'? cBTDWrite : cBTBWrite; if(!ctr) return setMsg('未就绪：缺少可写代币实例');
        const val = amount==='MAX'? MaxUint() : parseUnitsX(amount||'0', decimals);
        await estimateX(ctr, 'approve', spender, val);
        const tx = await ctr.approve(spender, val); setMsg('发送交易：'+tx.hash); await tx.wait(); setMsg('✅ Approve 成功');
      }catch(e){ console.error(e); setMsg(e?.message||String(e)); } }

      async function callMintBTD(){ if(!signer) return setMsg('请先连接钱包'); if(!cMintWrite?.mintBTD) return setMsg('Mint 合约中未找到 mintBTD'); try{
        if(!amtBTD || Number(amtBTD)<=0) return setMsg('请输入大于 0 的金额'); const val = parseUnitsX(amtBTD, decBTD);
        await estimateX(cMintWrite, 'mintBTD', val); const tx = await cMintWrite.mintBTD(val);
        setMsg('发送交易：'+tx.hash); await tx.wait(); setMsg('✅ Mint 成功'); refreshBalances();
      }catch(e){ console.error(e); setMsg(e?.message||String(e)); } }

      async function callBurnBTD(){ if(!signer) return setMsg('请先连接钱包'); if(!cMintWrite?.burnBTD) return setMsg('Mint 合约中未找到 burnBTD'); try{
        if(!amtBTD || Number(amtBTD)<=0) return setMsg('请输入大于 0 的金额'); const val = parseUnitsX(amtBTD, decBTD);
        await estimateX(cMintWrite, 'burnBTD', val); const tx = await cMintWrite.burnBTD(val);
        setMsg('发送交易：'+tx.hash); await tx.wait(); setMsg('✅ Burn BTD 成功'); refreshBalances();
      }catch(e){ console.error(e); setMsg(e?.message||String(e)); } }

      async function callBurnBTB(){ if(!signer) return setMsg('请先连接钱包'); if(!cMintWrite?.burnBTB) return setMsg('Mint 合约中未找到 burnBTB'); try{
        if(!amtBTBBurn || Number(amtBTBBurn)<=0) return setMsg('请输入大于 0 的金额'); const val = parseUnitsX(amtBTBBurn, decBTB);
        await estimateX(cMintWrite, 'burnBTB', val); const tx = await cMintWrite.burnBTB(val);
        setMsg('发送交易：'+tx.hash); await tx.wait(); setMsg('✅ Burn BTB 成功'); refreshBalances();
      }catch(e){ console.error(e); setMsg(e?.message||String(e)); } }

      async function callRebase(token){ try{
        if(!signer) return setMsg('请先连接钱包'); const ctr = token==='BTD'? cBTDWrite : cBTBWrite; if(!ctr?.rebase) return setMsg('该合约不支持 rebase');
        await estimateX(ctr, 'rebase'); const tx = await ctr.rebase(); setMsg('发送交易：'+tx.hash); await tx.wait(); setMsg(`✅ ${token} rebase 成功`); refreshBalances();
      }catch(e){ console.error(e); setMsg(e?.message||String(e)); } }

      async function callSetter(){ if(!signer) return setMsg('请先连接钱包'); if(!cConfigWrite) return setMsg('未就绪：Config 合约'); try{
        const dec = Number(priceDecimals||'8'); const val = String(setterValue).includes('.') ? parseUnitsX(setterValue, dec) : toUintRaw(setterValue);
        const fn = cConfigWrite[setterName]; if(!fn) return setMsg('Config 中未找到：'+setterName);
        await estimateX(cConfigWrite, setterName, val); const tx = await fn(val); setMsg('发送交易：'+tx.hash); await tx.wait(); setMsg('✅ 设置成功'); refreshConfigViews();
      }catch(e){ console.error(e); setMsg(e?.message||String(e)); } }

      // ===== 自检 =====
      const [tests,setTests] = useState([]);
      const add = (n,p,d)=> setTests(t=>[...t,{name:n,pass:p,detail:d}]);
      async function runTests(){ setTests([]);
        add('是否加载 ethers', !!E(), typeof E()); add('ethers 版本', isV6()?true:false, isV6()? 'v6' : (E()?.version || 'v5/未知'));
        add('地址格式：BTD', /^0x[0-9a-fA-F]{40}$/.test(addrBTD), addrBTD||'(空)');
        add('地址格式：BTB', /^0x[0-9a-fA-F]{40}$/.test(addrBTB), addrBTB||'(空)');
        add('地址格式：MINT', /^0x[0-9a-fA-F]{40}$/.test(addrMint), addrMint||'(空)');
        add('地址格式：CONFIG', /^0x[0-9a-fA-F]{40}$/.test(addrConfig), addrConfig||'(空)');
        const inj = getInjected(); add('检测 Provider 注入', !!inj, inj?'已注入':'未注入');
        add('是否 MetaMask', !!inj?.isMetaMask, String(!!inj?.isMetaMask)); add('是否 iframe', (function(){try{return window.self===window.top;}catch(_){return false;}})(), inIframe()? '在 iframe' : '非 iframe');
        try{ if(cBTD){ const d = await cBTD.decimals(); add('链上：BTD.decimals()', true, String(d)); } }catch(e){ add('链上只读：BTD', false, e?.message||String(e)); }
      }

      const small = 'text-sm text-gray-500';
      const openNew = ()=> { try{ window.open(window.location.href,'_blank'); }catch(_){} };
      const onConnect = async()=>{ try{ await connect(); setMsg('✅ 钱包已连接'); }catch(e){ setMsg(e?.message||String(e)); } };

      return (
        <div className="max-w-6xl mx-auto p-6 space-y-6">
          <div className="flex items-center justify-between">
            <div>
              <div className="text-2xl font-bold">BRS 前端 DApp（BTD / BTB）</div>
              <div className={small}>无打包版本 · 兼容 ethers v6/v5 · 修复 BrowserProvider 报错</div>
            </div>
            <div className="flex items-center gap-3 flex-wrap">
              <button onClick={openNew} className="text-xs underline text-gray-600">在新窗口打开</button>
              <div className="text-sm">{account?`${account.slice(0,6)}...${account.slice(-4)}`:'未连接'}{chainId?` · chain ${chainId}`:''}</div>
              <button onClick={onConnect} className="px-4 py-2 rounded-xl shadow bg-black text-white">{account? '已连接':'连接钱包'}</button>
            </div>
          </div>

          {(lastError || msg) && <div className="rounded-xl p-3 bg-yellow-50 border border-yellow-200 text-sm break-all">{msg || lastError}</div>}

          <Section title="合约配置（可按需修改）">
            <div className="grid md:grid-cols-2 gap-6">
              <div>
                <Field label="BTD 地址"><Input value={addrBTD} onChange={setAddrBTD} placeholder="0x..."/></Field>
                <Field label="BTB 地址"><Input value={addrBTB} onChange={setAddrBTB} placeholder="0x..."/></Field>
              </div>
              <div>
                <Field label="Mint 地址"><Input value={addrMint} onChange={setAddrMint} placeholder="0x..."/></Field>
                <Field label="Config 地址"><Input value={addrConfig} onChange={setAddrConfig} placeholder="0x..."/></Field>
              </div>
            </div>
          </Section>

          <Section title="账户信息">
            <div className="grid md:grid-cols-2 gap-6">
              <div className="rounded-xl p-4 bg-gray-50 border"><div className="font-semibold">BTD</div><div className="text-2xl mt-1">{balBTD}</div><div className={small}>decimals: {decBTD}</div></div>
              <div className="rounded-xl p-4 bg-gray-50 border"><div className="font-semibold">BTB</div><div className="text-2xl mt-1">{balBTB}</div><div className={small}>decimals: {decBTB}</div></div>
            </div>
            <div className="mt-3 flex gap-3">
              <button onClick={refreshBalances} className="px-4 py-2 rounded-xl shadow bg-black text-white">刷新余额</button>
              <button onClick={refreshConfigViews} className="px-4 py-2 rounded-xl shadow bg-black text-white">刷新参数</button>
            </div>
          </Section>

          <Section title="操作：Mint / Burn / Rebase / Approve">
            <div className="grid md:grid-cols-2 gap-6">
              <div className="space-y-3">
                <Field label={`BTD 数量（按 ${decBTD} 位小数）`}><Input value={amtBTD} onChange={setAmtBTD} placeholder="0.0"/></Field>
                <div className="flex gap-3 flex-wrap">
                  <button onClick={callMintBTD} className="px-4 py-2 rounded-xl shadow bg-black text-white">Mint BTD</button>
                  <button onClick={callBurnBTD} className="px-4 py-2 rounded-xl shadow bg-black text-white">Burn BTD</button>
                  <button onClick={()=>callRebase('BTD')} className="px-4 py-2 rounded-xl shadow bg-black text-white">BTD Rebase</button>
                </div>
                <div className="text-sm text-gray-500">若 Burn 失败，可能需要先 Approve BTD 给 Mint 合约。</div>
              </div>
              <div className="space-y-3">
                <Field label={`BTB Burn 数量（按 ${decBTB} 位小数）`}><Input value={amtBTBBurn} onChange={setAmtBTBBurn} placeholder="0.0"/></Field>
                <div className="flex gap-3 flex-wrap">
                  <button onClick={callBurnBTB} className="px-4 py-2 rounded-xl shadow bg-black text-white">Burn BTB</button>
                  <button onClick={()=>callRebase('BTB')} className="px-4 py-2 rounded-xl shadow bg-black text-white">BTB Rebase</button>
                </div>
                <div className="flex gap-3 flex-wrap mt-3">
                  <button onClick={()=>approveToken('BTD', addrMint, 'MAX', decBTD)} className="px-4 py-2 rounded-xl shadow bg-black text-white">Approve BTD → Mint(MAX)</button>
                  <button onClick={()=>approveToken('BTB', addrMint, 'MAX', decBTB)} className="px-4 py-2 rounded-xl shadow bg-black text-white">Approve BTB → Mint(MAX)</button>
                </div>
              </div>
            </div>
          </Section>

          <Section title="参数设置（Config：价格/年利率）">
            <div className="grid md:grid-cols-2 gap-6">
              <div className="grid grid-cols-2 gap-3">
                <Field label="Setter">
                  <select className="w-full rounded-xl border p-3 focus:outline-none focus:ring" value={setterName} onChange={(e)=>setSetterName(e.target.value)}>
                    <option value="setBtcPrice">setBtcPrice (BTC价)</option>
                    <option value="setBtbPrice">setBtbPrice (BTB价)</option>
                    <option value="setAnnualRateBP">setAnnualRateBP (年化BP)</option>
                  </select>
                </Field>
                <Field label={`输入值（解析为 ${priceDecimals} 位小数；纯整数视为原始值）`}>
                  <Input value={setterValue} onChange={setSetterValue} placeholder="例如：30000 或 30000.1234"/>
                </Field>
                <Field label="小数位">
                  <select className="w-full rounded-xl border p-3 focus:outline-none focus:ring" value={priceDecimals} onChange={(e)=>setPriceDecimals(e.target.value)}>
                    <option value="6">6</option><option value="8">8</option><option value="18">18</option>
                  </select>
                </Field>
                <div className="flex items-end"><button onClick={callSetter} className="px-4 py-2 rounded-xl shadow bg-black text-white">调用 Setter</button></div>
              </div>
              <div className="rounded-xl p-4 bg-gray-50 border space-y-1 text-sm">
                <div className="font-semibold mb-1">读取（只读）</div>
                <div>btcPrice: <code>{readBtcPrice}</code></div>
                <div>btbPrice: <code>{readBtbPrice}</code></div>
                <div>annualRateBP: <code>{readAnnualBP}</code></div>
              </div>
            </div>
          </Section>

          <Section title="自检用例（Sanity Tests）">
            <div className="flex gap-3 mb-3"><button onClick={runTests} className="px-4 py-2 rounded-xl shadow bg-black text-white">运行自检</button></div>
            <div className="space-y-2">
              {tests.length===0? <div className={small}>点击“运行自检”开始</div> : null}
              {tests.map((t,i)=> (
                <div key={i} className={`rounded-lg p-2 border ${t.pass? 'bg-green-50 border-green-200':'bg-red-50 border-red-200'}`}>
                  <div className="font-medium">{t.pass? '✅ 通过':'❌ 失败'} · {t.name}</div>
                  <div className="text-xs text-gray-600 break-all">{String(t.detail||'')}</div>
                </div>
              ))}
            </div>
          </Section>

          <div className="text-xs text-gray-500 pb-10">© {new Date().getFullYear()} BRS Demo UI — 兼容 v6/v5 的单文件版</div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
