import React, { useEffect, useMemo, useState } from "react";
import { ethers } from "ethers";

/**
 * BRS DApp — 单文件 React 组件（MetaMask 连接修复版）
 *
 * 修复点（针对 “Failed to connect to MetaMask” ）
 *  - 更稳健的注入检测：支持 window.ethereum.providers，优先选择 isMetaMask 的 provider
 *  - 统一在连接时 try/catch，并给出更友好的错误信息（用户拒绝/无注入/iframe 环境）
 *  - 读写分离（provider / signer），所有写操作先 estimateGas，便于弹出签名框
 *  - 提供“在新窗口打开”按钮以规避 iframe 阻止注入的问题
 *  - 自检用例新增：注入检测、isMetaMask、iframe 检测
 *
 * 现有测试用例保持不变，并**新增**连接相关自检；如果你的预期行为不同，请在聊天里告诉我。
 */

/** 默认合约地址（如与你的部署不一致，可在界面中修改） */
const DEFAULT_ADDR = {
  BTD: "0x15Ff979f693c4a4216C4Eb6214c0f9A47990168a",
  BTB: "0x3257E2aA1f2749c4b7B1C4c8D72909C102399925",
  MINT: "0xa6c7f04da936f248D7cde1b864382eDE7aE4211F",
  CONFIG: "0xd817fC345C2fE5e8726fE1b4eA4071139D12C8B4",
};

/** 最小 ERC20 片段（余额/授权/转账/小数位） */
const ERC20_MIN_ABI = [
  { type: "function", name: "name", stateMutability: "view", inputs: [], outputs: [{ type: "string" }] },
  { type: "function", name: "symbol", stateMutability: "view", inputs: [], outputs: [{ type: "string" }] },
  { type: "function", name: "decimals", stateMutability: "view", inputs: [], outputs: [{ type: "uint8" }] },
  { type: "function", name: "balanceOf", stateMutability: "view", inputs: [{ name: "owner", type: "address" }], outputs: [{ type: "uint256" }] },
  { type: "function", name: "allowance", stateMutability: "view", inputs: [{ name: "owner", type: "address" }, { name: "spender", type: "address" }], outputs: [{ type: "uint256" }] },
  { type: "function", name: "approve", stateMutability: "nonpayable", inputs: [{ name: "spender", type: "address" }, { name: "value", type: "uint256" }], outputs: [{ type: "bool" }] },
  { type: "function", name: "transfer", stateMutability: "nonpayable", inputs: [{ name: "to", type: "address" }, { name: "value", type: "uint256" }], outputs: [{ type: "bool" }] },
  { type: "function", name: "transferFrom", stateMutability: "nonpayable", inputs: [{ name: "from", type: "address" }, { name: "to", type: "address" }, { name: "value", type: "uint256" }], outputs: [{ type: "bool" }] },
];

/** BTD / BTB 片段（在 ERC20 基础上补充 rebase、年利率设置） */
const BTD_ABI = [
  ...ERC20_MIN_ABI,
  { type: "function", name: "rebase", stateMutability: "nonpayable", inputs: [], outputs: [] },
  { type: "function", name: "setAnnualRateBP", stateMutability: "nonpayable", inputs: [{ name: "rateBP", type: "uint256" }], outputs: [] },
];
const BTB_ABI = [
  ...ERC20_MIN_ABI,
  { type: "function", name: "rebase", stateMutability: "nonpayable", inputs: [], outputs: [] },
  { type: "function", name: "setAnnualRateBP", stateMutability: "nonpayable", inputs: [{ name: "rateBP", type: "uint256" }], outputs: [] },
];

/** Mint 合约片段（只包含本 DApp 会调用的方法） */
const MINT_ABI = [
  { type: "function", name: "mintBTD", stateMutability: "nonpayable", inputs: [{ name: "amount", type: "uint256" }], outputs: [] },
  { type: "function", name: "burnBTD", stateMutability: "nonpayable", inputs: [{ name: "amount", type: "uint256" }], outputs: [] },
  { type: "function", name: "burnBTB", stateMutability: "nonpayable", inputs: [{ name: "amount", type: "uint256" }], outputs: [] },
];

/** Config 合约片段（价格、年利率） */
const CONFIG_ABI = [
  { type: "function", name: "btcPrice", stateMutability: "view", inputs: [], outputs: [{ type: "uint256" }] },
  { type: "function", name: "btbPrice", stateMutability: "view", inputs: [], outputs: [{ type: "uint256" }] },
  { type: "function", name: "annualRateBP", stateMutability: "view", inputs: [], outputs: [{ type: "uint256" }] },
  { type: "function", name: "setBtcPrice", stateMutability: "nonpayable", inputs: [{ name: "p", type: "uint256" }], outputs: [] },
  { type: "function", name: "setBtbPrice", stateMutability: "nonpayable", inputs: [{ name: "p", type: "uint256" }], outputs: [] },
  { type: "function", name: "setAnnualRateBP", stateMutability: "nonpayable", inputs: [{ name: "rateBP", type: "uint256" }], outputs: [] },
];

/** 工具：更稳健地获取注入的以太坊对象（支持多钱包聚合） */
function getInjectedEthereum() {
  const w = typeof window !== "undefined" ? window : undefined;
  const eth = w?.ethereum;
  if (!eth) return null;
  // 一些浏览器/插件会把多个 provider 聚合在 window.ethereum.providers 中
  if (Array.isArray(eth.providers) && eth.providers.length > 0) {
    const mm = eth.providers.find((p) => p && p.isMetaMask);
    return mm || eth.providers[0];
  }
  return eth;
}
function inIframe() {
  try { return window.self !== window.top; } catch (e) { return true; }
}

/** 连接以太坊 */
function useEthers() {
  const [provider, setProvider] = useState(null);
  const [signer, setSigner] = useState(null);
  const [account, setAccount] = useState("");
  const [chainId, setChainId] = useState(null);
  const [lastError, setLastError] = useState("");

  async function connect() {
    setLastError("");
    try {
      const injected = getInjectedEthereum();
      if (!injected) {
        throw new Error("未检测到钱包注入（window.ethereum 不可用）。请确认已安装 MetaMask，或在新窗口打开页面。");
      }
      // 使用 'any' 网络，避免切链导致的 provider 失效问题
      const p = new ethers.BrowserProvider(injected, 'any');
      // 触发授权请求
      await p.send("eth_requestAccounts", []);
      const s = await p.getSigner();
      const net = await p.getNetwork();
      setProvider(p);
      setSigner(s);
      setAccount(await s.getAddress());
      setChainId(Number(net.chainId));
      return true;
    } catch (e) {
      // 标准化错误信息
      const raw = e?.message || String(e);
      let msg = raw;
      // 4001: 用户拒绝
      if (e && (e.code === 4001 || String(raw).includes("User rejected"))) {
        msg = "用户拒绝了连接请求。请在 MetaMask 中同意连接。";
      } else if (inIframe()) {
        msg = `可能是 iframe 环境未注入钱包。请点击右上角“在新窗口打开”后重试。原始错误：${raw}`;
      } else if (raw.toLowerCase().includes("metamask")) {
        msg = `连接 MetaMask 失败：${raw}`;
      }
      setLastError(msg);
      throw new Error(msg);
    }
  }

  useEffect(() => {
    const injected = getInjectedEthereum();
    if (!injected) return;
    const onChainChanged = () => window.location.reload();
    const onAccountsChanged = (accs) => setAccount(accs?.[0] || "");
    injected.on?.("chainChanged", onChainChanged);
    injected.on?.("accountsChanged", onAccountsChanged);
    return () => {
      injected.removeListener?.("chainChanged", onChainChanged);
      injected.removeListener?.("accountsChanged", onAccountsChanged);
    };
  }, []);

  return { provider, signer, account, chainId, connect, lastError };
}

/*** 主组件 ***/
function DApp() {
  const { provider, signer, account, chainId, connect, lastError } = useEthers();

  // 地址
  const [addrBTD, setAddrBTD] = useState(DEFAULT_ADDR.BTD);
  const [addrBTB, setAddrBTB] = useState(DEFAULT_ADDR.BTB);
  const [addrMint, setAddrMint] = useState(DEFAULT_ADDR.MINT);
  const [addrConfig, setAddrConfig] = useState(DEFAULT_ADDR.CONFIG);

  // 构造合约实例（读/写分离）
  const cBTD = useMemo(() => (provider && addrBTD ? new ethers.Contract(addrBTD, BTD_ABI, provider) : null), [provider, addrBTD]);
  const cBTDWrite = useMemo(() => (signer && addrBTD ? new ethers.Contract(addrBTD, BTD_ABI, signer) : null), [signer, addrBTD]);

  const cBTB = useMemo(() => (provider && addrBTB ? new ethers.Contract(addrBTB, BTB_ABI, provider) : null), [provider, addrBTB]);
  const cBTBWrite = useMemo(() => (signer && addrBTB ? new ethers.Contract(addrBTB, BTB_ABI, signer) : null), [signer, addrBTB]);

  const cMint = useMemo(() => (provider && addrMint ? new ethers.Contract(addrMint, MINT_ABI, provider) : null), [provider, addrMint]);
  const cMintWrite = useMemo(() => (signer && addrMint ? new ethers.Contract(addrMint, MINT_ABI, signer) : null), [signer, addrMint]);

  const cConfig = useMemo(() => (provider && addrConfig ? new ethers.Contract(addrConfig, CONFIG_ABI, provider) : null), [provider, addrConfig]);
  const cConfigWrite = useMemo(() => (signer && addrConfig ? new ethers.Contract(addrConfig, CONFIG_ABI, signer) : null), [signer, addrConfig]);

  // 代币信息与余额
  const [decBTD, setDecBTD] = useState(18);
  const [decBTB, setDecBTB] = useState(18);
  const [balBTD, setBalBTD] = useState("-");
  const [balBTB, setBalBTB] = useState("-");

  async function refreshBalances() {
    try {
      if (cBTD && account) {
        const d = (await cBTD.decimals().catch(() => 18)) || 18;
        setDecBTD(Number(d));
        const raw = await cBTD.balanceOf(account);
        setBalBTD(ethers.formatUnits(raw, Number(d)));
      }
      if (cBTB && account) {
        const d = (await cBTB.decimals().catch(() => 18)) || 18;
        setDecBTB(Number(d));
        const raw = await cBTB.balanceOf(account);
        setBalBTB(ethers.formatUnits(raw, Number(d)));
      }
    } catch (e) { console.error(e); }
  }
  useEffect(() => { refreshBalances(); }, [cBTD, cBTB, account]);

  // Config 只读数值
  const [readBtcPrice, setReadBtcPrice] = useState("-");
  const [readBtbPrice, setReadBtbPrice] = useState("-");
  const [readAnnualBP, setReadAnnualBP] = useState("-");
  async function refreshConfigViews() {
    try {
      if (!cConfig) return;
      const [bp, btbp, ann] = await Promise.all([
        cConfig.btcPrice().catch(() => null),
        cConfig.btbPrice().catch(() => null),
        cConfig.annualRateBP().catch(() => null),
      ]);
      setReadBtcPrice(bp !== null ? String(bp) : "-");
      setReadBtbPrice(btbp !== null ? String(btbp) : "-");
      setReadAnnualBP(ann !== null ? String(ann) : "-");
    } catch (e) { console.error(e); }
  }
  useEffect(() => { refreshConfigViews(); }, [cConfig]);

  // 输入表单
  const [amtBTD, setAmtBTD] = useState("0");
  const [amtBTBBurn, setAmtBTBBurn] = useState("0");

  const [setterName, setSetterName] = useState("setBtcPrice");
  const [setterValue, setSetterValue] = useState("0");
  const [priceDecimals, setPriceDecimals] = useState("8");

  // 消息提示
  const [msg, setMsg] = useState("");

  // Approve 工具
  async function approveToken(token, spender, amount, decimals) {
    try {
      if (!signer) return setMsg("请先连接钱包");
      const ctr = token === "BTD" ? cBTDWrite : cBTBWrite;
      if (!ctr) return setMsg("未就绪：缺少可写代币实例");
      const val = amount === "MAX" ? ethers.MaxUint256 : ethers.parseUnits(amount || "0", decimals);
      await ctr.approve.estimateGas(spender, val);
      const tx = await ctr.approve(spender, val);
      setMsg("发送交易：" + tx.hash);
      await tx.wait();
      setMsg("✅ Approve 成功");
    } catch (e) { console.error(e); setMsg(e?.message || String(e)); }
  }

  // 业务函数
  async function callMintBTD() {
    if (!signer) return setMsg("请先连接钱包");
    if (!cMintWrite) return setMsg("未就绪：Mint 合约");
    if (!cMintWrite.mintBTD) return setMsg("Mint 合约中未找到 mintBTD");
    try {
      if (!amtBTD || Number(amtBTD) <= 0) return setMsg("请输入大于 0 的金额");
      const val = ethers.parseUnits(amtBTD, decBTD);
      await cMintWrite.mintBTD.estimateGas(val);
      const tx = await cMintWrite.mintBTD(val);
      setMsg("发送交易：" + tx.hash);
      await tx.wait();
      setMsg("✅ Mint 成功");
      refreshBalances();
    } catch (e) { console.error(e); setMsg(e?.message || String(e)); }
  }

  async function callBurnBTD() {
    if (!signer) return setMsg("请先连接钱包");
    if (!cMintWrite) return setMsg("未就绪：Mint 合约");
    if (!cMintWrite.burnBTD) return setMsg("Mint 合约中未找到 burnBTD");
    try {
      if (!amtBTD || Number(amtBTD) <= 0) return setMsg("请输入大于 0 的金额");
      const val = ethers.parseUnits(amtBTD, decBTD);
      await cMintWrite.burnBTD.estimateGas(val);
      const tx = await cMintWrite.burnBTD(val);
      setMsg("发送交易：" + tx.hash);
      await tx.wait();
      setMsg("✅ Burn BTD 成功");
      refreshBalances();
    } catch (e) { console.error(e); setMsg(e?.message || String(e)); }
  }

  async function callBurnBTB() {
    if (!signer) return setMsg("请先连接钱包");
    if (!cMintWrite) return setMsg("未就绪：Mint 合约");
    if (!cMintWrite.burnBTB) return setMsg("Mint 合约中未找到 burnBTB");
    try {
      if (!amtBTBBurn || Number(amtBTBBurn) <= 0) return setMsg("请输入大于 0 的金额");
      const val = ethers.parseUnits(amtBTBBurn, decBTB);
      await cMintWrite.burnBTB.estimateGas(val);
      const tx = await cMintWrite.burnBTB(val);
      setMsg("发送交易：" + tx.hash);
      await tx.wait();
      setMsg("✅ Burn BTB 成功");
      refreshBalances();
    } catch (e) { console.error(e); setMsg(e?.message || String(e)); }
  }

  async function callRebase(token) {
    try {
      if (!signer) return setMsg("请先连接钱包");
      const ctr = token === "BTD" ? cBTDWrite : cBTBWrite;
      if (!ctr || !ctr.rebase) return setMsg("该合约不支持 rebase 或 ABI 未包含 rebase");
      await ctr.rebase.estimateGas();
      const tx = await ctr.rebase();
      setMsg("发送交易：" + tx.hash);
      await tx.wait();
      setMsg(`✅ ${token} rebase 成功`);
      refreshBalances();
    } catch (e) { console.error(e); setMsg(e?.message || String(e)); }
  }

  async function callSetter() {
    if (!signer) return setMsg("请先连接钱包");
    if (!cConfigWrite) return setMsg("未就绪：Config 合约");
    try {
      const dec = Number(priceDecimals || "8");
      const val = setterValue.includes(".") ? ethers.parseUnits(setterValue, dec) : BigInt(setterValue);
      const fn = cConfigWrite[setterName];
      if (!fn) return setMsg("Config 中未找到指定 setter：" + setterName);
      await fn.estimateGas(val);
      const tx = await fn(val);
      setMsg("发送交易：" + tx.hash);
      await tx.wait();
      setMsg("✅ 设置成功");
      refreshConfigViews();
    } catch (e) { console.error(e); setMsg(e?.message || String(e)); }
  }

  // ===== 自检用例（测试区） =====
  const [tests, setTests] = useState([]);
  function addTest(name, pass, detail) {
    setTests((prev) => [...prev, { name, pass, detail }]);
  }
  async function runSelfTests() {
    setTests([]);
    // 1. 地址格式（原有）
    addTest("地址格式：BTD", /^0x[0-9a-fA-F]{40}$/.test(addrBTD), addrBTD);
    addTest("地址格式：BTB", /^0x[0-9a-fA-F]{40}$/.test(addrBTB), addrBTB);
    addTest("地址格式：MINT", /^0x[0-9a-fA-F]{40}$/.test(addrMint), addrMint);
    addTest("地址格式：CONFIG", /^0x[0-9a-fA-F]{40}$/.test(addrConfig), addrConfig);
    // 2. ABI 方法存在性（原有）
    addTest("BTD ABI 含 rebase", !!BTD_ABI.find((f) => f.name === "rebase"), "rebase in BTD_ABI");
    addTest("BTB ABI 含 rebase", !!BTB_ABI.find((f) => f.name === "rebase"), "rebase in BTB_ABI");
    addTest("MINT ABI 含 mintBTD", !!MINT_ABI.find((f) => f.name === "mintBTD"), "mintBTD in MINT_ABI");
    addTest("MINT ABI 含 burnBTD", !!MINT_ABI.find((f) => f.name === "burnBTD"), "burnBTD in MINT_ABI");
    addTest("MINT ABI 含 burnBTB", !!MINT_ABI.find((f) => f.name === "burnBTB"), "burnBTB in MINT_ABI");
    addTest("CONFIG ABI 含 setBtcPrice", !!CONFIG_ABI.find((f) => f.name === "setBtcPrice"), "setBtcPrice in CONFIG_ABI");
    // 3. Provider 与账户（原有 + 新增）
    const injected = getInjectedEthereum();
    addTest("检测 Provider 注入", !!injected, injected ? "已注入" : "未注入");
    addTest("Provider 是否 MetaMask", !!injected?.isMetaMask, String(!!injected?.isMetaMask));
    addTest("当前是否 iframe", inIframe() === false, inIframe() ? "在 iframe 中" : "非 iframe");
    addTest("账户连接状态", !!account, account || "未连接");
    // 4. 动态读链（原有）
    try {
      if (cBTD) {
        const d = await cBTD.decimals();
        addTest("链上调用：BTD.decimals()", typeof Number(d) === "number", String(d));
      }
      if (cBTB) {
        const d = await cBTB.decimals();
        addTest("链上调用：BTB.decimals()", typeof Number(d) === "number", String(d));
      }
    } catch (e) {
      addTest("链上读取（decimals）", false, e?.message || String(e));
    }
  }

  const small = "text-sm text-gray-500";

  async function handleConnect() {
    setMsg("");
    try {
      await connect();
      setMsg("✅ 钱包已连接");
    } catch (e) {
      setMsg(e?.message || String(e));
    }
  }

  function openInNewWindow() {
    try { window.open(window.location.href, "_blank"); } catch (e) {}
  }

  return (
    <div className="min-h-screen bg-gradient-to-b from-gray-50 to-gray-100">
      <div className="max-w-6xl mx-auto p-6 space-y-6">
        <div className="flex items-center justify-between">
          <div>
            <div className="text-2xl font-bold">BRS 前端 DApp（BTD / BTB）</div>
            <div className={small}>MetaMask 连接修复：多 provider 兼容 · 连接错误友好提示 · 自检扩展</div>
          </div>
          <div className="flex items-center gap-3 flex-wrap">
            <button onClick={openInNewWindow} className="text-xs underline text-gray-600">在新窗口打开</button>
            <div className="text-sm">{account ? `${account.slice(0,6)}...${account.slice(-4)}` : "未连接"}{chainId ? ` · chain ${chainId}` : ""}</div>
            <button onClick={handleConnect} className="px-4 py-2 rounded-xl shadow bg-black text-white">{account ? "已连接" : "连接钱包"}</button>
          </div>
        </div>

        {(msg || lastError) ? (
          <div className="rounded-xl p-3 bg-yellow-50 border border-yellow-200 text-sm break-all">{msg || lastError}</div>
        ) : null}

        <Section title="合约配置（可按需修改）">
          <div className="grid md:grid-cols-2 gap-6">
            <div>
              <Field label="BTD 地址"><Input value={addrBTD} onChange={setAddrBTD} placeholder="0x..." /></Field>
              <Field label="BTB 地址"><Input value={addrBTB} onChange={setAddrBTB} placeholder="0x..." /></Field>
            </div>
            <div>
              <Field label="Mint 地址"><Input value={addrMint} onChange={setAddrMint} placeholder="0x..." /></Field>
              <Field label="Config 地址"><Input value={addrConfig} onChange={setAddrConfig} placeholder="0x..." /></Field>
            </div>
          </div>
        </Section>

        <Section title="账户信息">
          <div className="grid md:grid-cols-2 gap-6">
            <div className="rounded-xl p-4 bg-gray-50 border">
              <div className="font-semibold">BTD</div>
              <div className="text-2xl mt-1">{balBTD}</div>
              <div className={small}>decimals: {decBTD}</div>
            </div>
            <div className="rounded-xl p-4 bg-gray-50 border">
              <div className="font-semibold">BTB</div>
              <div className="text-2xl mt-1">{balBTB}</div>
              <div className={small}>decimals: {decBTB}</div>
            </div>
          </div>
          <div className="mt-3 flex gap-3">
            <button onClick={refreshBalances} className="px-4 py-2 rounded-xl shadow bg-black text-white">刷新余额</button>
            <button onClick={refreshConfigViews} className="px-4 py-2 rounded-xl shadow bg-black text-white">刷新参数</button>
          </div>
        </Section>

        <Section title="操作：Mint / Burn / Rebase / Approve">
          <div className="grid md:grid-cols-2 gap-6">
            <div className="space-y-3">
              <Field label={`BTD 数量（按 ${decBTD} 位小数）`}><Input value={amtBTD} onChange={setAmtBTD} placeholder="0.0" /></Field>
              <div className="flex gap-3 flex-wrap">
                <button onClick={callMintBTD} className="px-4 py-2 rounded-xl shadow bg-black text-white">Mint BTD</button>
                <button onClick={callBurnBTD} className="px-4 py-2 rounded-xl shadow bg-black text-white">Burn BTD</button>
                <button onClick={() => callRebase("BTD")} disabled={!cBTD || !cBTD.rebase} className="px-4 py-2 rounded-xl shadow bg-black text-white disabled:opacity-50 disabled:cursor-not-allowed">BTD Rebase</button>
              </div>
              <div className={small}>提示：若 Burn 调用失败，可能需要先 Approve BTD 给 Mint 合约。</div>
            </div>
            <div className="space-y-3">
              <Field label={`BTB Burn 数量（按 ${decBTB} 位小数）`}><Input value={amtBTBBurn} onChange={setAmtBTBBurn} placeholder="0.0" /></Field>
              <div className="flex gap-3 flex-wrap">
                <button onClick={callBurnBTB} className="px-4 py-2 rounded-xl shadow bg-black text-white">Burn BTB</button>
                <button onClick={() => callRebase("BTB")} disabled={!cBTB || !cBTB.rebase} className="px-4 py-2 rounded-xl shadow bg-black text-white disabled:opacity-50 disabled:cursor-not-allowed">BTB Rebase</button>
              </div>
              <div className="flex gap-3 flex-wrap mt-3">
                <button onClick={() => approveToken("BTD", addrMint, "MAX", decBTD)} className="px-4 py-2 rounded-xl shadow bg-black text-white">Approve BTD → Mint(MAX)</button>
                <button onClick={() => approveToken("BTB", addrMint, "MAX", decBTB)} className="px-4 py-2 rounded-xl shadow bg-black text-white">Approve BTB → Mint(MAX)</button>
              </div>
            </div>
          </div>
        </Section>

        <Section title="参数设置（Config：价格/年利率）">
          <div className="grid md:grid-cols-2 gap-6">
            <div className="grid grid-cols-2 gap-3">
              <Field label="Setter">
                <select className="w-full rounded-xl border p-3 focus:outline-none focus:ring" value={setterName} onChange={(e)=>setSetterName(e.target.value)}>
                  <option value="setBtcPrice">setBtcPrice (BTC价)</option>
                  <option value="setBtbPrice">setBtbPrice (BTB价)</option>
                  <option value="setAnnualRateBP">setAnnualRateBP (年化BP)</option>
                </select>
              </Field>
              <Field label={`输入值（解析为 ${priceDecimals} 位小数；纯整数视为原始值）`}>
                <Input value={setterValue} onChange={setSetterValue} placeholder="例如：30000 或 30000.1234" />
              </Field>
              <Field label="小数位">
                <select className="w-full rounded-xl border p-3 focus:outline-none focus:ring" value={priceDecimals} onChange={(e)=>setPriceDecimals(e.target.value)}>
                  <option value="6">6</option>
                  <option value="8">8</option>
                  <option value="18">18</option>
                </select>
              </Field>
              <div className="flex items-end"><button onClick={callSetter} className="px-4 py-2 rounded-xl shadow bg-black text-white">调用 Setter</button></div>
            </div>
            <div className="rounded-xl p-4 bg-gray-50 border space-y-1 text-sm">
              <div className="font-semibold mb-1">读取（只读）</div>
              <div>btcPrice: <code>{readBtcPrice}</code></div>
              <div>btbPrice: <code>{readBtbPrice}</code></div>
              <div>annualRateBP: <code>{readAnnualBP}</code></div>
            </div>
          </div>
        </Section>

        <Section title="自检用例（Sanity Tests）">
          <div className="flex gap-3 mb-3">
            <button onClick={runSelfTests} className="px-4 py-2 rounded-xl shadow bg-black text-white">运行自检</button>
          </div>
          <div className="space-y-2">
            {tests.length === 0 ? <div className={small}>点击“运行自检”开始</div> : null}
            {tests.map((t, i) => (
              <div key={i} className={`rounded-lg p-2 border ${t.pass ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`}>
                <div className="font-medium">{t.pass ? '✅ 通过' : '❌ 失败'} · {t.name}</div>
                <div className="text-xs text-gray-600 break-all">{String(t.detail || '')}</div>
              </div>
            ))}
          </div>
        </Section>

        <div className="text-xs text-gray-500 pb-10">© {new Date().getFullYear()} BRS Demo UI — MetaMask 连接修复版</div>
      </div>
    </div>
  );
}

export default DApp;
