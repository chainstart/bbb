import React, { useEffect, useMemo, useState } from "react";
import { ethers } from "ethers";

/**
 * BRS DApp — 单文件 React 组件（修复版）
 * 修复内容：
 *  - 彻底清理了不成对的大括号/try…catch 残片与插入文本，修复 SyntaxError: Unexpected token (258:4)
 *  - 所有写操作改为 signer 实例；读操作使用 provider 实例；发交易前先 estimateGas 暴露错误
 *  - 维持现有“自检用例”，并新增若干用例；保留 UI/功能不变
 *
 * 功能：
 *  1) 连接钱包（MetaMask）
 *  2) Mint / Burn BTD；Burn BTB
 *  3) 对 BTD、BTB 执行 rebase（若 ABI 中存在）
 *  4) 设置 BTC 价格、BTB 价格、年化利率（Config 合约）
 *  5) Approve（将 BTD/BTB 授权给 Mint 合约）
 *  6) 内置“自检用例”，帮助定位配置/ABI 问题
 */

/** 默认合约地址（如与你的部署不一致，可在界面中修改） */
const DEFAULT_ADDR = {
  BTD: "0x15Ff979f693c4a4216C4Eb6214c0f9A47990168a",
  BTB: "0x3257E2aA1f2749c4b7B1C4c8D72909C102399925",
  MINT: "0xa6c7f04da936f248D7cde1b864382eDE7aE4211F",
  CONFIG: "0xd817fC345C2fE5e8726fE1b4eA4071139D12C8B4",
};

/** 最小 ERC20 片段（余额/授权/转账/小数位） */
const ERC20_MIN_ABI = [
  { type: "function", name: "name", stateMutability: "view", inputs: [], outputs: [{ type: "string" }] },
  { type: "function", name: "symbol", stateMutability: "view", inputs: [], outputs: [{ type: "string" }] },
  { type: "function", name: "decimals", stateMutability: "view", inputs: [], outputs: [{ type: "uint8" }] },
  { type: "function", name: "balanceOf", stateMutability: "view", inputs: [{ name: "owner", type: "address" }], outputs: [{ type: "uint256" }] },
  { type: "function", name: "allowance", stateMutability: "view", inputs: [{ name: "owner", type: "address" }, { name: "spender", type: "address" }], outputs: [{ type: "uint256" }] },
  { type: "function", name: "approve", stateMutability: "nonpayable", inputs: [{ name: "spender", type: "address" }, { name: "value", type: "uint256" }], outputs: [{ type: "bool" }] },
  { type: "function", name: "transfer", stateMutability: "nonpayable", inputs: [{ name: "to", type: "address" }, { name: "value", type: "uint256" }], outputs: [{ type: "bool" }] },
  { type: "function", name: "transferFrom", stateMutability: "nonpayable", inputs: [{ name: "from", type: "address" }, { name: "to", type: "address" }, { name: "value", type: "uint256" }], outputs: [{ type: "bool" }] },
];

/** BTD / BTB 片段（在 ERC20 基础上补充 rebase、年利率设置） */
const BTD_ABI = [
  ...ERC20_MIN_ABI,
  { type: "function", name: "rebase", stateMutability: "nonpayable", inputs: [], outputs: [] },
  { type: "function", name: "setAnnualRateBP", stateMutability: "nonpayable", inputs: [{ name: "rateBP", type: "uint256" }], outputs: [] },
];
const BTB_ABI = [
  ...ERC20_MIN_ABI,
  { type: "function", name: "rebase", stateMutability: "nonpayable", inputs: [], outputs: [] },
  { type: "function", name: "setAnnualRateBP", stateMutability: "nonpayable", inputs: [{ name: "rateBP", type: "uint256" }], outputs: [] },
];

/** Mint 合约片段（只包含本 DApp 会调用的方法） */
const MINT_ABI = [
  { type: "function", name: "mintBTD", stateMutability: "nonpayable", inputs: [{ name: "amount", type: "uint256" }], outputs: [] },
  { type: "function", name: "burnBTD", stateMutability: "nonpayable", inputs: [{ name: "amount", type: "uint256" }], outputs: [] },
  { type: "function", name: "burnBTB", stateMutability: "nonpayable", inputs: [{ name: "amount", type: "uint256" }], outputs: [] },
];

/** Config 合约片段（价格、年利率） */
const CONFIG_ABI = [
  { type: "function", name: "btcPrice", stateMutability: "view", inputs: [], outputs: [{ type: "uint256" }] },
  { type: "function", name: "btbPrice", stateMutability: "view", inputs: [], outputs: [{ type: "uint256" }] },
  { type: "function", name: "annualRateBP", stateMutability: "view", inputs: [], outputs: [{ type: "uint256" }] },
  { type: "function", name: "setBtcPrice", stateMutability: "nonpayable", inputs: [{ name: "p", type: "uint256" }], outputs: [] },
  { type: "function", name: "setBtbPrice", stateMutability: "nonpayable", inputs: [{ name: "p", type: "uint256" }], outputs: [] },
  { type: "function", name: "setAnnualRateBP", stateMutability: "nonpayable", inputs: [{ name: "rateBP", type: "uint256" }], outputs: [] },
];

/** UI 组件 */
function Section(props) {
  return (
    <div className="rounded-2xl shadow p-5 bg-white border border-gray-100">
      <div className="text-xl font-semibold mb-4">{props.title}</div>
      {props.children}
    </div>
  );
}
function Field(props) {
  return (
    <label className="block mb-3">
      <div className="text-sm text-gray-600 mb-1">{props.label}</div>
      {props.children}
    </label>
  );
}
function Input(props) {
  return (
    <input
      className="w-full rounded-xl border p-3 focus:outline-none focus:ring"
      value={props.value}
      onChange={(e) => props.onChange(e.target.value)}
      placeholder={props.placeholder}
      type={props.type || "text"}
    />
  );
}
function Button(props) {
  return (
    <button
      onClick={props.onClick}
      disabled={props.disabled}
      className="px-4 py-2 rounded-xl shadow disabled:opacity-50 disabled:cursor-not-allowed bg-black text-white"
    >
      {props.children}
    </button>
  );
}
function Select(props) {
  return (
    <select
      className="w-full rounded-xl border p-3 focus:outline-none focus:ring"
      value={props.value}
      onChange={(e) => props.onChange(e.target.value)}
    >
      {(props.options || []).map((op) => (
        <option key={String(op.value ?? op)} value={op.value ?? op}>{op.label ?? op}</option>
      ))}
    </select>
  );
}

/** 连接以太坊 */
function useEthers() {
  const [provider, setProvider] = useState(null);
  const [signer, setSigner] = useState(null);
  const [account, setAccount] = useState("");
  const [chainId, setChainId] = useState(null);

  async function connect() {
    if (!(window && window.ethereum)) throw new Error("请安装 MetaMask");
    const p = new ethers.BrowserProvider(window.ethereum);
    await p.send("eth_requestAccounts", []);
    const s = await p.getSigner();
    const net = await p.getNetwork();
    setProvider(p);
    setSigner(s);
    setAccount(await s.getAddress());
    setChainId(Number(net.chainId));
  }

  useEffect(() => {
    const eth = window && window.ethereum;
    if (!eth) return;
    const onChainChanged = () => window.location.reload();
    const onAccountsChanged = (accs) => setAccount(accs[0] || "");
    eth.on && eth.on("chainChanged", onChainChanged);
    eth.on && eth.on("accountsChanged", onAccountsChanged);
    return () => {
      eth.removeListener && eth.removeListener("chainChanged", onChainChanged);
      eth.removeListener && eth.removeListener("accountsChanged", onAccountsChanged);
    };
  }, []);

  return { provider, signer, account, chainId, connect };
}

/*** 主组件 ***/
function DApp() {
  const { provider, signer, account, chainId, connect } = useEthers();

  // 地址
  const [addrBTD, setAddrBTD] = useState(DEFAULT_ADDR.BTD);
  const [addrBTB, setAddrBTB] = useState(DEFAULT_ADDR.BTB);
  const [addrMint, setAddrMint] = useState(DEFAULT_ADDR.MINT);
  const [addrConfig, setAddrConfig] = useState(DEFAULT_ADDR.CONFIG);

  // 构造合约实例（读/写分离）
  const cBTD = useMemo(() => (provider && addrBTD ? new ethers.Contract(addrBTD, BTD_ABI, provider) : null), [provider, addrBTD]);
  const cBTDWrite = useMemo(() => (signer && addrBTD ? new ethers.Contract(addrBTD, BTD_ABI, signer) : null), [signer, addrBTD]);

  const cBTB = useMemo(() => (provider && addrBTB ? new ethers.Contract(addrBTB, BTB_ABI, provider) : null), [provider, addrBTB]);
  const cBTBWrite = useMemo(() => (signer && addrBTB ? new ethers.Contract(addrBTB, BTB_ABI, signer) : null), [signer, addrBTB]);

  const cMint = useMemo(() => (provider && addrMint ? new ethers.Contract(addrMint, MINT_ABI, provider) : null), [provider, addrMint]);
  const cMintWrite = useMemo(() => (signer && addrMint ? new ethers.Contract(addrMint, MINT_ABI, signer) : null), [signer, addrMint]);

  const cConfig = useMemo(() => (provider && addrConfig ? new ethers.Contract(addrConfig, CONFIG_ABI, provider) : null), [provider, addrConfig]);
  const cConfigWrite = useMemo(() => (signer && addrConfig ? new ethers.Contract(addrConfig, CONFIG_ABI, signer) : null), [signer, addrConfig]);

  // 代币信息与余额
  const [decBTD, setDecBTD] = useState(18);
  const [decBTB, setDecBTB] = useState(18);
  const [balBTD, setBalBTD] = useState("-");
  const [balBTB, setBalBTB] = useState("-");

  async function refreshBalances() {
    try {
      if (cBTD && account) {
        const d = (await cBTD.decimals().catch(() => 18)) || 18;
        setDecBTD(Number(d));
        const raw = await cBTD.balanceOf(account);
        setBalBTD(ethers.formatUnits(raw, Number(d)));
      }
      if (cBTB && account) {
        const d = (await cBTB.decimals().catch(() => 18)) || 18;
        setDecBTB(Number(d));
        const raw = await cBTB.balanceOf(account);
        setBalBTB(ethers.formatUnits(raw, Number(d)));
      }
    } catch (e) {
      console.error(e);
    }
  }
  useEffect(() => { refreshBalances(); }, [cBTD, cBTB, account]);

  // Config 只读数值
  const [readBtcPrice, setReadBtcPrice] = useState("-");
  const [readBtbPrice, setReadBtbPrice] = useState("-");
  const [readAnnualBP, setReadAnnualBP] = useState("-");
  async function refreshConfigViews() {
    try {
      if (!cConfig) return;
      const [bp, btbp, ann] = await Promise.all([
        cConfig.btcPrice().catch(() => null),
        cConfig.btbPrice().catch(() => null),
        cConfig.annualRateBP().catch(() => null),
      ]);
      setReadBtcPrice(bp !== null ? String(bp) : "-");
      setReadBtbPrice(btbp !== null ? String(btbp) : "-");
      setReadAnnualBP(ann !== null ? String(ann) : "-");
    } catch (e) { console.error(e); }
  }
  useEffect(() => { refreshConfigViews(); }, [cConfig]);

  // 输入表单
  const [amtBTD, setAmtBTD] = useState("0");
  const [amtBTBBurn, setAmtBTBBurn] = useState("0");

  const [setterName, setSetterName] = useState("setBtcPrice");
  const [setterValue, setSetterValue] = useState("0");
  const [priceDecimals, setPriceDecimals] = useState("8");

  // 消息提示
  const [msg, setMsg] = useState("");

  // Approve 工具
  async function approveToken(token, spender, amount, decimals) {
    try {
      if (!signer) return setMsg("请先连接钱包");
      const ctr = token === "BTD" ? cBTDWrite : cBTBWrite;
      if (!ctr) return setMsg("未就绪：缺少可写代币实例");
      const val = amount === "MAX" ? ethers.MaxUint256 : ethers.parseUnits(amount || "0", decimals);
      await ctr.approve.estimateGas(spender, val);
      const tx = await ctr.approve(spender, val);
      setMsg("发送交易：" + tx.hash);
      await tx.wait();
      setMsg("✅ Approve 成功");
    } catch (e) { console.error(e); setMsg(e?.message || String(e)); }
  }

  // 业务函数
  async function callMintBTD() {
    if (!signer) return setMsg("请先连接钱包");
    if (!cMintWrite) return setMsg("未就绪：Mint 合约");
    if (!cMintWrite.mintBTD) return setMsg("Mint 合约中未找到 mintBTD");
    try {
      if (!amtBTD || Number(amtBTD) <= 0) return setMsg("请输入大于 0 的金额");
      const val = ethers.parseUnits(amtBTD, decBTD);
      await cMintWrite.mintBTD.estimateGas(val);
      const tx = await cMintWrite.mintBTD(val);
      setMsg("发送交易：" + tx.hash);
      await tx.wait();
      setMsg("✅ Mint 成功");
      refreshBalances();
    } catch (e) { console.error(e); setMsg(e?.message || String(e)); }
  }

  async function callBurnBTD() {
    if (!signer) return setMsg("请先连接钱包");
    if (!cMintWrite) return setMsg("未就绪：Mint 合约");
    if (!cMintWrite.burnBTD) return setMsg("Mint 合约中未找到 burnBTD");
    try {
      if (!amtBTD || Number(amtBTD) <= 0) return setMsg("请输入大于 0 的金额");
      const val = ethers.parseUnits(amtBTD, decBTD);
      await cMintWrite.burnBTD.estimateGas(val);
      const tx = await cMintWrite.burnBTD(val);
      setMsg("发送交易：" + tx.hash);
      await tx.wait();
      setMsg("✅ Burn BTD 成功");
      refreshBalances();
    } catch (e) { console.error(e); setMsg(e?.message || String(e)); }
  }

  async function callBurnBTB() {
    if (!signer) return setMsg("请先连接钱包");
    if (!cMintWrite) return setMsg("未就绪：Mint 合约");
    if (!cMintWrite.burnBTB) return setMsg("Mint 合约中未找到 burnBTB");
    try {
      if (!amtBTBBurn || Number(amtBTBBurn) <= 0) return setMsg("请输入大于 0 的金额");
      const val = ethers.parseUnits(amtBTBBurn, decBTB);
      await cMintWrite.burnBTB.estimateGas(val);
      const tx = await cMintWrite.burnBTB(val);
      setMsg("发送交易：" + tx.hash);
      await tx.wait();
      setMsg("✅ Burn BTB 成功");
      refreshBalances();
    } catch (e) { console.error(e); setMsg(e?.message || String(e)); }
  }

  async function callRebase(token) {
    try {
      if (!signer) return setMsg("请先连接钱包");
      const ctr = token === "BTD" ? cBTDWrite : cBTBWrite;
      if (!ctr || !ctr.rebase) return setMsg("该合约不支持 rebase 或 ABI 未包含 rebase");
      await ctr.rebase.estimateGas();
      const tx = await ctr.rebase();
      setMsg("发送交易：" + tx.hash);
      await tx.wait();
      setMsg(`✅ ${token} rebase 成功`);
      refreshBalances();
    } catch (e) { console.error(e); setMsg(e?.message || String(e)); }
  }

  async function callSetter() {
    if (!signer) return setMsg("请先连接钱包");
    if (!cConfigWrite) return setMsg("未就绪：Config 合约");
    try {
      const dec = Number(priceDecimals || "8");
      const val = setterValue.includes(".") ? ethers.parseUnits(setterValue, dec) : BigInt(setterValue);
      const fn = cConfigWrite[setterName];
      if (!fn) return setMsg("Config 中未找到指定 setter：" + setterName);
      await fn.estimateGas(val);
      const tx = await fn(val);
      setMsg("发送交易：" + tx.hash);
      await tx.wait();
      setMsg("✅ 设置成功");
      refreshConfigViews();
    } catch (e) { console.error(e); setMsg(e?.message || String(e)); }
  }

  // ===== 自检用例（测试区） =====
  const [tests, setTests] = useState([]);
  function addTest(name, pass, detail) {
    setTests((prev) => [...prev, { name, pass, detail }]);
  }
  async function runSelfTests() {
    setTests([]);
    // 1. 地址格式
    addTest("地址格式：BTD", /^0x[0-9a-fA-F]{40}$/.test(addrBTD), addrBTD);
    addTest("地址格式：BTB", /^0x[0-9a-fA-F]{40}$/.test(addrBTB), addrBTB);
    addTest("地址格式：MINT", /^0x[0-9a-fA-F]{40}$/.test(addrMint), addrMint);
    addTest("地址格式：CONFIG", /^0x[0-9a-fA-F]{40}$/.test(addrConfig), addrConfig);
    // 2. ABI 方法存在性
    addTest("BTD ABI 含 rebase", !!BTD_ABI.find((f) => f.name === "rebase"), "rebase in BTD_ABI");
    addTest("BTB ABI 含 rebase", !!BTB_ABI.find((f) => f.name === "rebase"), "rebase in BTB_ABI");
    addTest("MINT ABI 含 mintBTD", !!MINT_ABI.find((f) => f.name === "mintBTD"), "mintBTD in MINT_ABI");
    addTest("MINT ABI 含 burnBTD", !!MINT_ABI.find((f) => f.name === "burnBTD"), "burnBTD in MINT_ABI");
    addTest("MINT ABI 含 burnBTB", !!MINT_ABI.find((f) => f.name === "burnBTB"), "burnBTB in MINT_ABI");
    addTest("CONFIG ABI 含 setBtcPrice", !!CONFIG_ABI.find((f) => f.name === "setBtcPrice"), "setBtcPrice in CONFIG_ABI");
    // 3. Provider 与账户
    addTest("检测 Provider", !!(window && window.ethereum), "window.ethereum 存在");
    addTest("账户连接状态", !!account, account || "未连接");
    // 4. 动态读链（可选）
    try {
      if (cBTD) {
        const d = await cBTD.decimals();
        addTest("链上调用：BTD.decimals()", typeof Number(d) === "number", String(d));
      }
      if (cBTB) {
        const d = await cBTB.decimals();
        addTest("链上调用：BTB.decimals()", typeof Number(d) === "number", String(d));
      }
    } catch (e) {
      addTest("链上读取（decimals）", false, e?.message || String(e));
    }
  }

  const small = "text-sm text-gray-500";

  return (
    <div className="min-h-screen bg-gradient-to-b from-gray-50 to-gray-100">
      <div className="max-w-6xl mx-auto p-6 space-y-6">
        <div className="flex items-center justify-between">
          <div>
            <div className="text-2xl font-bold">BRS 前端 DApp（BTD / BTB）</div>
            <div className={small}>修复版：单文件 · 读写分离 · 发交易前 estimateGas · 内置自检</div>
          </div>
          <div className="flex items-center gap-3">
            <div className="text-sm">{account ? `${account.slice(0,6)}...${account.slice(-4)}` : "未连接"}{chainId ? ` · chain ${chainId}` : ""}</div>
            <Button onClick={connect}>{account ? "已连接" : "连接钱包"}</Button>
          </div>
        </div>

        {msg ? (
          <div className="rounded-xl p-3 bg-yellow-50 border border-yellow-200 text-sm break-all">{msg}</div>
        ) : null}

        <Section title="合约配置（可按需修改）">
          <div className="grid md:grid-cols-2 gap-6">
            <div>
              <Field label="BTD 地址"><Input value={addrBTD} onChange={setAddrBTD} placeholder="0x..." /></Field>
              <Field label="BTB 地址"><Input value={addrBTB} onChange={setAddrBTB} placeholder="0x..." /></Field>
            </div>
            <div>
              <Field label="Mint 地址"><Input value={addrMint} onChange={setAddrMint} placeholder="0x..." /></Field>
              <Field label="Config 地址"><Input value={addrConfig} onChange={setAddrConfig} placeholder="0x..." /></Field>
            </div>
          </div>
        </Section>

        <Section title="账户信息">
          <div className="grid md:grid-cols-2 gap-6">
            <div className="rounded-xl p-4 bg-gray-50 border">
              <div className="font-semibold">BTD</div>
              <div className="text-2xl mt-1">{balBTD}</div>
              <div className={small}>decimals: {decBTD}</div>
            </div>
            <div className="rounded-xl p-4 bg-gray-50 border">
              <div className="font-semibold">BTB</div>
              <div className="text-2xl mt-1">{balBTB}</div>
              <div className={small}>decimals: {decBTB}</div>
            </div>
          </div>
          <div className="mt-3 flex gap-3">
            <Button onClick={refreshBalances}>刷新余额</Button>
            <Button onClick={refreshConfigViews}>刷新参数</Button>
          </div>
        </Section>

        <Section title="操作：Mint / Burn / Rebase / Approve">
          <div className="grid md:grid-cols-2 gap-6">
            <div className="space-y-3">
              <Field label={`BTD 数量（按 ${decBTD} 位小数）`}><Input value={amtBTD} onChange={setAmtBTD} placeholder="0.0" /></Field>
              <div className="flex gap-3 flex-wrap">
                <Button onClick={callMintBTD}>Mint BTD</Button>
                <Button onClick={callBurnBTD}>Burn BTD</Button>
                <Button onClick={() => callRebase("BTD")} disabled={!cBTD || !cBTD.rebase}>BTD Rebase</Button>
              </div>
              <div className={small}>提示：若 Burn 调用失败，可能需要先 Approve BTD 给 Mint 合约。</div>
            </div>
            <div className="space-y-3">
              <Field label={`BTB Burn 数量（按 ${decBTB} 位小数）`}><Input value={amtBTBBurn} onChange={setAmtBTBBurn} placeholder="0.0" /></Field>
              <div className="flex gap-3 flex-wrap">
                <Button onClick={callBurnBTB}>Burn BTB</Button>
                <Button onClick={() => callRebase("BTB")} disabled={!cBTB || !cBTB.rebase}>BTB Rebase</Button>
              </div>
              <div className="flex gap-3 flex-wrap mt-3">
                <Button onClick={() => approveToken("BTD", addrMint, "MAX", decBTD)}>Approve BTD → Mint(MAX)</Button>
                <Button onClick={() => approveToken("BTB", addrMint, "MAX", decBTB)}>Approve BTB → Mint(MAX)</Button>
              </div>
            </div>
          </div>
        </Section>

        <Section title="参数设置（Config：价格/年利率）">
          <div className="grid md:grid-cols-2 gap-6">
            <div className="grid grid-cols-2 gap-3">
              <Field label="Setter">
                <Select value={setterName} onChange={setSetterName} options={[
                  { value: "setBtcPrice", label: "setBtcPrice (BTC价)" },
                  { value: "setBtbPrice", label: "setBtbPrice (BTB价)" },
                  { value: "setAnnualRateBP", label: "setAnnualRateBP (年化BP)" },
                ]} />
              </Field>
              <Field label={`输入值（解析为 ${priceDecimals} 位小数；纯整数视为原始值）`}>
                <Input value={setterValue} onChange={setSetterValue} placeholder="例如：30000 或 30000.1234" />
              </Field>
              <Field label="小数位">
                <Select value={priceDecimals} onChange={setPriceDecimals} options={["6","8","18"]} />
              </Field>
              <div className="flex items-end"><Button onClick={callSetter}>调用 Setter</Button></div>
            </div>
            <div className="rounded-xl p-4 bg-gray-50 border space-y-1 text-sm">
              <div className="font-semibold mb-1">读取（只读）</div>
              <div>btcPrice: <code>{readBtcPrice}</code></div>
              <div>btbPrice: <code>{readBtbPrice}</code></div>
              <div>annualRateBP: <code>{readAnnualBP}</code></div>
            </div>
          </div>
        </Section>

        <Section title="自检用例（Sanity Tests）">
          <div className="flex gap-3 mb-3"><Button onClick={runSelfTests}>运行自检</Button></div>
          <div className="space-y-2">
            {tests.length === 0 ? <div className={small}>点击“运行自检”开始</div> : null}
            {tests.map((t, i) => (
              <div key={i} className={`rounded-lg p-2 border ${t.pass ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`}>
                <div className="font-medium">{t.pass ? '✅ 通过' : '❌ 失败'} · {t.name}</div>
                <div className="text-xs text-gray-600 break-all">{String(t.detail || '')}</div>
              </div>
            ))}
          </div>
        </Section>

        <div className="text-xs text-gray-500 pb-10">© {new Date().getFullYear()} BRS Demo UI — 修复版</div>
      </div>
    </div>
  );
}

export default DApp;
